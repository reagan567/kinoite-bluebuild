name: bluebuild-nvidia
on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-standard:
    name: Build Standard Image (Safety Net)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      # Validation: Checks recipe and configuration health before starting the heavy build
      - name: Run Trivy vulnerability scanner (Config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          hide-progress: true
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      # Standard build: Ensures an un-chunked image is always available in the registry
      - name: Build Standard Image
        uses: blue-build/github-action@v1.11
        with:
          recipe: recipe-nvidia.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true
          build_chunked_oci: false
          use_cache: true

      # Security Audit: Checks the final Nvidia-specific image for known CVEs
      - name: Run Trivy vulnerability scanner (Image)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/kinoite-nvidia:latest
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      # SBOM: Essential for tracking proprietary driver versions and dependencies
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository_owner }}/kinoite-nvidia:latest
          format: spdx-json
          output-file: ./sbom.spdx.json

  build-optimized:
    name: Build Optimized Image (Chunked)
    needs: build-standard
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      # Enhanced Build: Overwrites 'latest' with a chunked version to optimize client-side bandwidth
      - name: Build Optimized Image
        uses: blue-build/github-action@v1.11
        with:
          recipe: recipe-nvidia.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true
          build_chunked_oci: true
          use_cache: true