name: bluebuild-amd
on:
  pull_request:
  workflow_dispatch:

concurrency:
  # Prevents multiple concurrent builds on the same reference to save resources
  # If a new commit is pushed, the previous pending build is cancelled
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  bluebuild:
    name: Build Standard Image
    runs-on: ubuntu-latest
    # runs-on: self-hosted
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: true # Stop GH from cancelling all matrix builds if one fails
      matrix:
        recipe:
          - recipe-amd.yml
    steps:

      # - name: Checkout repo
      #   uses: actions/checkout@v6

      # # Validation: Checks recipe and configuration health before starting the heavy build
      # - name: Run Trivy vulnerability scanner (Config)
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'config'
      #     hide-progress: true
      #     exit-code: '1'
      #     severity: 'CRITICAL,HIGH'

      # Standard build: Ensures an un-chunked image is always available in the registry
      # For amd, we might want chunked OCI enabled if clients support it, but consistent with AMD is safer
      - name: Build Standard Image
        uses: blue-build/github-action@v1.11
        with:
          recipe: ${{ matrix.recipe }}
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true
          build_chunked_oci: false # Enabled here as per your original config (Optimized pull)
          use_cache: true

      # # Security Audit: Checks the final amd-specific image for known CVEs
      # - name: Run Trivy vulnerability scanner (Image)
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     image-ref: ghcr.io/${{ github.repository_owner }}/kinoite-amd:latest
      #     format: 'table'
      #     exit-code: '0'
      #     severity: 'CRITICAL,HIGH'

      # # SBOM: Essential for tracking proprietary driver versions and dependencies
      # - name: Generate SBOM
      #   uses: anchore/sbom-action@v0
      #   with:
      #     image: ghcr.io/${{ github.repository_owner }}/kinoite-amd:latest
      #     format: spdx-json
      #     output-file: ./sbom.spdx.json

  # bluebuild-optimized:
  #   name: Build Optimized Image (Chunked)
  #   needs: bluebuild
  #   runs-on: ubuntu-latest
  #   # runs-on: self-hosted
  #   permissions:
  #     contents: read
  #     packages: write
  #     id-token: write
  #   steps:
  #     - name: Checkout repo
  #       uses: actions/checkout@v6
  #
  #     # Enhanced Build: Overwrites 'latest' with a chunked version to optimize client-side bandwidth
  #     - name: Build Optimized Image
  #       uses: blue-build/github-action@v1.11
  #       with:
  #         recipe: ${{ matrix.recipe }}
  #         cosign_private_key: ${{ secrets.SIGNING_SECRET }}
  #         registry_token: ${{ github.token }}
  #         pr_event_number: ${{ github.event.number }}
  #         maximize_build_space: true
  #         build_chunked_oci: true
  #         use_cache: true