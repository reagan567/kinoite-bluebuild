name: bluebuild-amd
on:
  pull_request:
  workflow_dispatch: # Allows manual triggering from the GitHub Actions tab

concurrency:
  # Prevents multiple concurrent builds on the same reference to save resources
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-standard:
    name: Build Standard Image (Safety Net)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      # Pre-build check: Verify configuration files for severe security issues
      - name: Run Trivy vulnerability scanner (Config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          hide-progress: true
          exit-code: '1' # Fail the build if critical/high issues are found in config
          severity: 'CRITICAL,HIGH'

      # Standard build: Published as the first layer of reliability
      - name: Build Standard Image
        uses: blue-build/github-action@v1.11
        with:
          recipe: recipe-amd.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }} # Required for Pull Request labels/comments
          maximize_build_space: true
          build_chunked_oci: false # Standard OCI format for maximum compatibility
          use_cache: true # Speeds up subsequent builds by caching container layers

      # Post-build check: Scan the newly created image for package vulnerabilities
      - name: Run Trivy vulnerability scanner (Image)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/kinoite-amd:latest
          format: 'table'
          exit-code: '0' # Reports findings without failing to ensure the safety net remains available
          severity: 'CRITICAL,HIGH'

      # Generate Software Bill of Materials (SBOM) for supply chain transparency
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository_owner }}/kinoite-amd:latest
          format: spdx-json
          output-file: ./sbom.spdx.json

  build-optimized:
    name: Build Optimized Image (Chunked)
    needs: build-standard # Only proceeds if the standard image is successfully published
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      # Optimized build: Uses content-addressable chunks for faster user updates
      - name: Build Optimized Image
        uses: blue-build/github-action@v1.11
        with:
          recipe: recipe-amd.yml
          cosign_private_key: ${{ secrets.SIGNING_SECRET }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          maximize_build_space: true
          build_chunked_oci: true # Enables ZSTD-chunked format for smaller delta downloads
          use_cache: true